# MRL (Matryoshka Representation Learning) 配置说明

## 什么是 MRL？

MRL 是一种训练技术，允许将高维向量截断到较低维度，同时保持大部分语义信息。这样可以在存储空间和检索性能之间取得平衡。

## 配置说明

在 `application.yml` 中配置：

```yaml
embedding:
  original-dimension: 4096    # 原始向量维度（Qwen3-Embedding-2B 输出维度）
  target-dimension: 2048      # 目标存储维度（支持: 256, 512, 1024, 2048）
```

## 支持的维度

- **256 维**: 最小存储，适合超大规模数据集
- **512 维**: 平衡性能和存储
- **1024 维**: 较好的检索质量
- **2048 维**: 高质量检索（推荐）

## 工作原理

1. **文档处理时**:
   - Qwen3-Embedding-2B 生成 4096 维向量
   - MrlService 截断到 2048 维
   - 存储到 PostgreSQL (vector(2048))

2. **问答查询时**:
   - 问题生成 4096 维向量
   - MrlService 截断到 2048 维
   - 与数据库中的 2048 维向量进行相似度计算

## 优势

✅ **节省存储空间**: 2048 维比 4096 维节省 50% 空间
✅ **提升检索速度**: 维度越低，向量计算越快
✅ **保持语义质量**: MRL 训练确保截断后仍保留主要语义信息
✅ **灵活调整**: 可根据需求调整目标维度

## 性能对比

| 维度 | 存储空间 | 检索速度 | 语义质量 |
|------|---------|---------|---------|
| 256  | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| 512  | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| 1024 | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| 2048 | ⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐⭐ |
| 4096 | ⭐ | ⭐ | ⭐⭐⭐⭐⭐ |

## 修改维度

如果要修改目标维度，需要：

1. 修改 `application.yml` 中的 `target-dimension`
2. 修改 `init-db/01-init.sql` 中的 `vector(2048)` 为对应维度
3. 修改 `VectorRecord.java` 中的维度定义
4. 重建数据库

## 注意事项

⚠️ **维度必须一致**: 数据库定义的维度必须与配置文件中的 `target-dimension` 一致
⚠️ **不可混用**: 同一个数据库中的所有向量必须使用相同的维度
⚠️ **重建数据**: 修改维度后需要重新处理所有文档

## 相关文件

- `MrlService.java`: MRL 核心服务
- `DocumentProcessorService.java`: 文档处理时使用 MRL
- `QaService.java`: 问答查询时使用 MRL
- `application.yml`: MRL 配置
- `init-db/01-init.sql`: 数据库向量维度定义
